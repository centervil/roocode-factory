# Design: Quality Gate Integration

## Architecture
The Quality Gate system will act as a validator that sits between "Implementation" and "Completion". It will compare the latest collected metrics against the defined policies.

### Components
1.  **Policy Source**: `.roo/policies/quality.yaml` and `metrics.yaml`. (We may need to simplify these or provide a parser).
2.  **Metrics Source**: `.ops/audit_logs/metrics.json` (generated by `run-audit.sh`).
3.  **Gatekeeper Script**: A new script `.gemini/skills/skill-metrics-manager/scripts/check-gates.sh`.
4.  **Orchestrator Hook**: The `AGENTS.md` operational rules will be updated to require a "Gate Pass" before completion.

## Implementation Details

### 1. Gatekeeper Script (`check-gates.sh`)
- **Inputs**: Latest `metrics.json` and policy files.
- **Logic**:
    - Parse `metrics.json` for values like `test_pass_rate`, `code_churn`, `compliance_score`.
    - Compare these values against thresholds defined in `metrics.yaml`.
- **Outputs**: 
    - Exit code 0 if all critical/major gates pass.
    - Non-zero exit code if any gate fails.
    - A summary report (Markdown) indicating pass/fail for each metric.

### 2. Integration with `run-audit.sh`
Update `run-audit.sh` to optionally call `check-gates.sh` at the end of the audit process.

### 3. Policy Update
We need to ensure `metrics.yaml` contains machine-readable thresholds that match the keys in `metrics.json`.

## Evaluation Criteria
- Rejection works: If I intentionally break a test, `check-gates.sh` must return a failure.
- Detailed Feedback: The error message must specify *which* metric failed.
